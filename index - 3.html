
<!DOCTYPE html>
<html lang="zh-Hant-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¦™æ¸¯å¯¦æ™‚è»Šä½åœ°åœ–</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- jQuery (Updated to latest version) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .district-section .toggle-bar {
      cursor: pointer;
      background-color: #3498db;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      transition: background-color 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .district-section .toggle-bar:hover {
      background-color: #2980b9;
    }
    .district-section .toggle-icon {
      transition: transform 0.3s ease;
    }
    .district-section .toggle-bar.active .toggle-icon {
      transform: rotate(180deg);
    }
    .district-section .content {
      display: none;
      animation: slideDown 0.3s ease-out;
    }
    .district-section .content.active {
      display: block;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 5000px;
      }
    }
    
    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
    }
    .loading-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error Alert */
    .error-alert {
      background-color: #fee;
      border: 1px solid #f88;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem;
      color: #c00;
    }
    .error-alert button {
      background-color: #c00;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .error-alert button:hover {
      background-color: #a00;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }
    .status-online {
      background-color: #d1fae5;
      color: #065f46;
    }
    .status-offline {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    /* Responsive layout adjustments */
    @media (max-width: 767px) {
      main {
        flex-direction: column;
      }
      #map {
        height: 60vh;
        width: 100%;
        order: 1;
      }
      aside {
        width: 100%;
        max-height: 40vh;
        overflow-y: auto;
        order: 2;
        background-color: white;
        border-top: 1px solid #d1d5db;
      }
      aside h2 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }
    }
    @media (min-width: 768px) {
      main {
        flex-direction: row;
      }
      aside {
        width: 33.333%;
        order: 1;
      }
      #map {
        flex: 1;
        height: 100%;
        order: 2;
      }
    }
    
    /* Smooth scrollbar */
    aside::-webkit-scrollbar {
      width: 8px;
    }
    aside::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    aside::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    aside::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p class="mt-4 text-lg">è¼‰å…¥ä¸­...</p>
  </div>

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">é¦™æ¸¯å¯¦æ™‚è»Šä½åœ°åœ–</h1>
      <div class="flex items-center gap-2">
        <span id="lastUpdateTime" class="text-sm opacity-90"></span>
        <span id="statusBadge" class="status-badge status-online">é€£ç·šä¸­</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex flex-1 overflow-hidden">
    <!-- Car Park Sections (left on desktop, bottom on mobile) -->
    <aside class="bg-white p-4 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">åœè»Šå ´ (æŒ‰18å€åˆ†çµ„)</h2>
        <button id="refreshBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
          ğŸ”„ æ›´æ–°
        </button>
      </div>
      <div id="district-sections"></div>
      <div class="text-red-500 text-sm mt-4">
        * è³‡æ–™ä¸å®šæ™‚æ›´æ–°ï¼Œåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è³‡æ–™è«‹å‘ç›¸é—œåœè»Šå ´æŸ¥è©¢ã€‚
      </div>
    </aside>

    <!-- Map Container (right on desktop, top on mobile) -->
    <div id="map" class="flex-1"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white p-4 text-center">
    <p>
      è³‡æ–™ä¾†æºï¼š<a href="https://data.gov.hk" class="underline hover:text-blue-300">DATA.GOV.HK</a> | 
      åœ°åœ–ä¾†æºï¼š<a href="https://www.map.gov.hk" class="underline hover:text-blue-300">é¦™æ¸¯åœ°åœ– (åœ°æ”¿ç¸½ç½² GeoInfo Map)</a>
    </p>
  </footer>

  <script>
    // Initialize the map with Hong Kong GeoData official basemap
    const map = L.map('map').setView([22.3193, 114.1694], 11);

    // Official LandsD topographic basemap (raster)
    const topoBasemap = L.tileLayer('https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/WGS84/{z}/{x}/{y}.png', {
      attribution: 'Â© é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æ”¿åºœ åœ°æ”¿ç¸½ç½² Lands Department, HKSAR',
      maxZoom: 20,
      minZoom: 10,
      tileSize: 256,
      crossOrigin: 'anonymous'
    });

    // English labels overlay
    const labels = L.tileLayer('https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/en/WGS84/{z}/{x}/{y}.png', {
      attribution: 'Â© Lands Department, HKSAR',
      maxZoom: 20,
      minZoom: 10,
      opacity: 0.95,
      zIndex: 1000
    });

    // Add default layers
    topoBasemap.addTo(map);
    labels.addTo(map);

    // Simple layer control
    const baseLayers = { "å®˜æ–¹åœ°å½¢åœ–": topoBasemap };
    const overlayLayers = { "åœ°åæ¨™ç±¤ (è‹±æ–‡)": labels };
    L.control.layers(baseLayers, overlayLayers, { position: 'topright' }).addTo(map);

    // Marker cluster group for better performance
    const markerCluster = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    });
    map.addLayer(markerCluster);

    // Store markers
    const markers = [];

    // Hong Kong's 18 districts
    const hkDistricts = [
      'ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'ç£ä»”å€', 'ä¹é¾åŸå€', 'è§€å¡˜å€', 'æ·±æ°´åŸ—å€', 'é»ƒå¤§ä»™å€', 'æ²¹å°–æ—ºå€',
      'é›¢å³¶å€', 'è‘µé’å€', 'åŒ—å€', 'è¥¿è²¢å€', 'æ²™ç”°å€', 'å¤§åŸ”å€', 'èƒç£å€', 'å±¯é–€å€', 'å…ƒæœ—å€'
    ];

    // Show loading overlay
    function showLoading() {
      $('#loadingOverlay').fadeIn(200);
    }

    // Hide loading overlay
    function hideLoading() {
      $('#loadingOverlay').fadeOut(200);
    }

    // Update status badge
    function updateStatus(online) {
      const badge = $('#statusBadge');
      if (online) {
        badge.removeClass('status-offline').addClass('status-online').text('é€£ç·šä¸­');
      } else {
        badge.removeClass('status-online').addClass('status-offline').text('é›¢ç·š');
      }
    }

    // Update last update time
    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleString('zh-HK', { 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit'
      });
      $('#lastUpdateTime').text(`æœ€å¾Œæ›´æ–°: ${timeString}`);
    }

    // Show error message
    function showError(message) {
      const errorHtml = `
        <div class="error-alert">
          <h3 class="font-bold mb-2">âš ï¸ è¼‰å…¥å¤±æ•—</h3>
          <p>${message}</p>
          <button onclick="fetchCarParkData()">é‡è©¦</button>
        </div>
      `;
      $('#district-sections').html(errorHtml);
      updateStatus(false);
    }

    // Fetch car park data with improved error handling
    async function fetchCarParkData() {
      try {
        showLoading();
        updateStatus(true);

        const [infoResponse, vacancyResponse] = await Promise.all([
          fetch('https://api.data.gov.hk/v1/carpark-info-vacancy?lang=zh_TW'),
          fetch('https://api.data.gov.hk/v1/carpark-info-vacancy?data=vacancy&vehicleTypes=privateCar&lang=zh_TW')
        ]);

        if (!infoResponse.ok || !vacancyResponse.ok) {
          throw new Error('API å›æ‡‰éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }

        const infoData = await infoResponse.json();
        const vacancyData = await vacancyResponse.json();

        if (!infoData.results || !vacancyData.results) {
          throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚');
        }

        let carParks = infoData.results.map(info => {
          const vacancy = vacancyData.results.find(v => v.park_Id === info.park_Id) || {};
          return {
            type: 'car_park',
            park_Id: info.park_Id,
            name: info.name,
            address: info.displayAddress || 'ç„¡è³‡æ–™',
            district: info.district || 'æ–°ç•Œå€',
            latitude: info.latitude,
            longitude: info.longitude,
            privateCar: vacancy.privateCar || [],
            update_time: vacancy.privateCar?.[0]?.lastupdate || 'ç„¡è³‡æ–™'
          };
        });

        displayCarParks(carParks);
        updateLastUpdateTime();
        hideLoading();

      } catch (error) {
        console.error('Error fetching data:', error);
        hideLoading();
        showError(error.message || 'ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚');
      }
    }

    // Display car parks with improved UI
    function displayCarParks(carParks) {
      const sections = $('#district-sections');
      sections.empty();
      
      // Clear existing markers
      markerCluster.clearLayers();
      markers.length = 0;

      const districtGroups = {};
      hkDistricts.forEach(d => districtGroups[d] = []);

      // Group car parks by district
      carParks.forEach(carPark => {
        if (!carPark.latitude || !carPark.longitude) return;
        
        // Filter out é’è¯åœè»Šå ´
        if (carPark.name && carPark.name.includes('é’è¯åœè»Šå ´')) return;

        let district = carPark.district;
        
        // District mapping for common locations
        const districtMapping = {
          'æ²¹éº»åœ°': 'æ²¹å°–æ—ºå€',
          'éŠ…é‘¼ç£': 'ç£ä»”å€',
          'å°–æ²™å’€': 'æ²¹å°–æ—ºå€',
          'èƒç£': 'èƒç£å€',
          'æ²™ç”°': 'æ²™ç”°å€'
        };

        for (const [keyword, mappedDistrict] of Object.entries(districtMapping)) {
          if (carPark.name.includes(keyword)) {
            district = mappedDistrict;
            break;
          }
        }

        if (!hkDistricts.includes(district)) {
          district = 'æ–°ç•Œå€';
        }

        carPark.district = district;
        if (hkDistricts.includes(district)) {
          districtGroups[district].push(carPark);
        }
      });

      // Create district sections
      hkDistricts.forEach(district => {
        const carParksInDistrict = districtGroups[district];
        if (carParksInDistrict.length === 0) return;

        const section = $('<div>').addClass('district-section mb-4');
        const toggleBar = $('<div>')
          .addClass('toggle-bar')
          .html(`
            <span>${district} (${carParksInDistrict.length} å€‹åœè»Šå ´)</span>
            <span class="toggle-icon">â–¼</span>
          `);
        const content = $('<div>').addClass('content');

        const list = $('<ul>').addClass('space-y-2 mb-4');

        carParksInDistrict.forEach(carPark => {
          const vacancy = carPark.privateCar[0]?.vacancy || 0;
          const hasVacancy = vacancy > 0;
          
          // Create marker
          const markerStyle = {
            radius: 10,
            color: hasVacancy ? '#3498db' : '#95a5a6',
            fillColor: hasVacancy ? '#3498db' : '#95a5a6',
            weight: 1,
            opacity: hasVacancy ? 1 : 0.5,
            fillOpacity: hasVacancy ? 0.7 : 0.3
          };
          const marker = L.circleMarker([carPark.latitude, carPark.longitude], markerStyle);
          
          // Determine vacancy display and background color
          let vacancyText = 'ç„¡è³‡æ–™';
          let listBgColor = '#f9fafb'; // default gray-50
          
          if (carPark.privateCar && carPark.privateCar.length > 0) {
            const vacancyType = carPark.privateCar[0].vacancy_type || '';
            if (vacancyType === 'A' && vacancy > 0) {
              vacancyText = `ç©ºä½: ${vacancy}`;
              listBgColor = '#50FF3E'; // green background
            } else if ((vacancyType === 'B' || vacancyType === 'C') && vacancy > 0) {
              vacancyText = 'ç©ºä½: æœ‰ç©ºä½';
              listBgColor = '#50FF3E'; // green background
            } else if (vacancy === 0) {
              vacancyText = 'ç©ºä½: æ»¿';
              listBgColor = '#FF8488'; // red background
            } else {
              vacancyText = 'ç©ºä½: ç„¡è³‡æ–™';
            }
          } else {
            vacancyText = 'ç©ºä½: ç„¡è³‡æ–™';
          }

          // Bind popup
          marker.bindPopup(`
            <div style="min-width: 200px;">
              <b style="font-size: 16px;">${carPark.name}</b><br>
              <div style="margin-top: 8px;">
                <b>åœ°å€:</b> ${carPark.address}<br>
                <b>ç©ºç½®è»Šä½:</b> <span style="color: ${hasVacancy ? '#059669' : '#dc2626'}; font-weight: bold;">${vacancyText}</span><br>
                <b>æœ€å¾Œæ›´æ–°:</b> ${carPark.update_time}
              </div>
            </div>
          `);

          markerCluster.addLayer(marker);
          markers.push({ marker, carPark });

          // Create list item with background color
          const li = $('<li>')
            .addClass('p-3 rounded cursor-pointer hover:opacity-80 transition')
            .css({
              'background-color': listBgColor,
              'border': '1px solid #e5e7eb'
            })
            .html(`
              <div class="font-medium">${carPark.name}</div>
              <div class="text-sm">${vacancyText}</div>
            `)
            .click(() => {
              map.setView([carPark.latitude, carPark.longitude], 16);
              marker.openPopup();
            });
          list.append(li);
        });

        content.append(list);
        section.append(toggleBar).append(content);
        sections.append(section);

        // Toggle functionality
        toggleBar.click(function() {
          $(this).toggleClass('active');
          content.toggleClass('active');
        });
      });
    }

    // Manual refresh button
    $('#refreshBtn').click(() => {
      fetchCarParkData();
    });

    // Fetch data initially and every 5 minutes
    fetchCarParkData();
    const updateInterval = setInterval(fetchCarParkData, 5 * 60 * 1000);

    // Clean up on page unload
    $(window).on('beforeunload', () => {
      clearInterval(updateInterval);
    });
  </script>
</body>
</html>
